generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  role      String   @default("STAFF") // ADMIN, STAFF
  createdAt DateTime @default(now())
  logs          Log[]
  notifications Notification[]
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Company {
  id        String   @id @default(cuid())
  name      String
  type      String   // Shipping Line, Forwarder...
  services  String   // Ocean, Air... (stored as comma joined string for simple MVP)
  whatsapp  String
  email     String?
  contact   String?  // Contact Person
  routes    String?  // Description of routes
  rating    Int      @default(0)
  country   String?  // New: Country of the company
  createdAt DateTime @default(now())
  
  rfqs      RFQ[]    @relation("TargetedCompanies") 
  quotes    Quote[]
  shipments     Shipment[]
  quoteRequests QuoteRequest[]
  
  // Inverse relations for Shipment Roles
  shipmentsAsSupplier Shipment[] @relation("ShipmentSupplier")
  shipmentsAsImporter Shipment[] @relation("ShipmentImporter")
  shipmentsAsFactory  Shipment[] @relation("ShipmentFactory")
}

model RFQ {
  id              String    @id @default(cuid())
  title           String
  mode            String    // Ocean, Air
  status          String    @default("DRAFT") // DRAFT, SENT, AWARDED, CLOSED
  pol             String
  pod             String
  containerType   String?
  containerCount  Int?
  weight          Float?    // For LCL/Air
  commodity       String
  incoterm        String
  freeDays        Int       @default(21)
  targetDate      DateTime?
  createdAt       DateTime  @default(now())
  
  targetCompanies Company[] @relation("TargetedCompanies")
  quotes          Quote[]
  shipment        Shipment?
  quoteRequests   QuoteRequest[]
}

model Quote {
  id        String   @id @default(cuid())
  rfqId     String
  rfq       RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  price     Float
  currency  String   @default("USD")
  validity  DateTime?
  notes     String?
  freeDays  Int?
  transitTime String?
  status    String   @default("RECEIVED") // RECEIVED, REJECTED, WINNER
  createdAt DateTime @default(now())
}

model Shipment {
  id        String   @id @default(cuid())
  rfqId     String   @unique
  rfq       RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  status    String   @default("BOOKED") // BOOKED, AT_SEA, ARRIVED, CLEARED, DELIVERED
  bookingNo String?
  blNo      String?
  acidNumber String?  // ACID Number
  shippingLine String? // The Carrier (e.g., Maersk, MSC)
  trackingData String? // JSON string for simulated tracking history
  vessel    String?
  
  // Business Parties (Coding)
  supplierId String?
  supplier   Company? @relation("ShipmentSupplier", fields: [supplierId], references: [id])
  importerId String?
  importer   Company? @relation("ShipmentImporter", fields: [importerId], references: [id])
  factoryId  String?
  factory    Company? @relation("ShipmentFactory", fields: [factoryId], references: [id])
  
  etd       DateTime?
  eta       DateTime?
  notes     String?
  createdAt DateTime @default(now())
}

model Log {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    String
  details   String?
  createdAt DateTime @default(now())
}

model QuoteRequest {
  id        String   @id @default(cuid())
  rfqId     String
  rfq       RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  token     String   @unique
  status    String   @default("PENDING") // PENDING, VIEWED, SUBMITTED
  createdAt DateTime @default(now())
  
  @@unique([rfqId, companyId])
}
